name: Laravel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
        with:
          php-version: "8.1"
          extensions: mbstring, ctype, fileinfo, openssl, PDO, bcmath, json, tokenizer, xml, cURL, BCMath, DOM, PCRE
      - uses: actions/checkout@v2
      
      - name: install npm packages
        run:  |
            npm install
            npm run prod
      
      - name: Compile CSS and Javascript
        run: |
          npm ci
          npm run prod
            
      - name: Copy .env
        run: php -r "file_exists('.env') || copy('.env.example', '.env');"
            
      - name: Install Dependencies
        run: |
           composer update -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
           composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader 
           
      - name: Generate key
        run: php artisan key:generate

      - name: Directory Permissions
        run: chmod -R 775 storage bootstrap/cache
     
      - name: multiple command
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            cd /var/www/ems/backend/greenestate-ems-estate-admin
            git checkout -f
            git pull
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            mv .env.example .env
            composer dump-autoload
            php artisan key:generate
